error_log /var/log/nginx/error.log debug;
worker_processes  auto;

events {
    worker_connections  1024;
}

daemon off;

http {
    include 	mime.types;
    include		nginx-gz.conf;
    resolver 	10.0.5.33 valid=1s;#use local DNS and override TTL to whatever value makes sense

    client_max_body_size 30M;

	upstream backend {
		zone backend 	64k;
		server 			pages.marathon.mesos:31100 resolve;
		least_time 		last_byte;
		keepalive 		300;
	}


    server {
        listen 80;
        return         301 https://$host$request_uri;
	}

	server {

        listen       443 ssl http2;
        ssl_certificate      /etc/letsencrypt/live/mesos.ps.nginxlab.com/fullchain.pem;
        ssl_certificate_key  /etc/letsencrypt/live/mesos.ps.nginxlab.com/privkey.pem;
        ## verify chain of trust of OCSP response using Root CA and Intermediate certs
    	ssl_trusted_certificate /etc/letsencrypt/live/mesos.ps.nginxlab.com/chain.pem;

		include		nginx-ssl.conf;
        rewrite_log on;
        
        status_zone auth_proxy;
        
		keepalive_timeout	3600s;
		keepalive_disable	none;
		keepalive_requests  100000;
		
        location /status.html { 
        	root /usr/share/nginx/html/;
        }
        
        location /status {
            status;
        }

        location /pages/status.html { 
            proxy_pass https://backend/status.html;
            proxy_set_header Host pages.marathon.mesos;
            
            proxy_ssl_session_reuse 	on;
			proxy_ssl_protocols         TLSv1.2;
			#proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
			proxy_ssl_verify 			off;
			proxy_read_timeout     		3600;
 			proxy_connect_timeout  		3600;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";

        }
        
        location /pages/status {
            proxy_pass https://backend/status;
            proxy_set_header Host pages.marathon.mesos;
            
            proxy_ssl_session_reuse 	on;
			proxy_ssl_protocols         TLSv1.2;
			#proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
			proxy_ssl_verify 			off;
			proxy_read_timeout     		3600;
 			proxy_connect_timeout  		3600;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
        }
        
        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2|woff|ttf)$ {
            proxy_pass https://backend;
            proxy_set_header Host pages.marathon.mesos;

            proxy_ssl_session_reuse 	on;
			proxy_ssl_protocols         TLSv1.2;
			#proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
			proxy_ssl_verify 			off;
			proxy_read_timeout     		3600;
 			proxy_connect_timeout  		3600;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
         }

    	location = / {
            proxy_pass https://backend;
            proxy_set_header Host pages.marathon.mesos;

            proxy_ssl_session_reuse 	on;
			proxy_ssl_protocols         TLSv1.2;
			#proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
			proxy_ssl_verify 			off;
			proxy_read_timeout     		3600;
 			proxy_connect_timeout  		3600;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
	    }

        location / {
            auth_request /auth-proxy;

            # the auth daemon will set name and email in response headers
            auth_request_set $auth_id $upstream_http_auth_id;
            auth_request_set $auth_name $upstream_http_auth_name;
            auth_request_set $auth_email $upstream_http_auth_email;
            auth_request_set $auth_facebook_id $upstream_http_auth_facebook_id;
            auth_request_set $auth_google_id $upstream_http_auth_google_id;
            auth_request_set $auth_result $upstream_http_auth_result;

            # pass data from auth daemon to backend
            proxy_set_header "Auth-ID" $auth_id;
            proxy_set_header "Auth-Name" $auth_name;
            proxy_set_header "Auth-Email" $auth_email;
            proxy_set_header "Auth-Facebook-ID" $auth_facebook_id;
            proxy_set_header "Auth-Google-ID" $auth_google_id;
            proxy_set_header "Auth-Result" $auth_result;

            proxy_pass https://backend;
            proxy_set_header Host pages.marathon.mesos;
            proxy_ssl_session_reuse 	on;
			proxy_ssl_protocols         TLSv1.2;
			#proxy_ssl_ciphers           'ECDHE-RSA-AES128-GCM-SHA256';
			proxy_ssl_verify 			off;
			proxy_read_timeout     		3600;
 			proxy_connect_timeout  		3600;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
        }

        location = /auth-proxy {
            internal;

            proxy_pass http://127.0.0.1:8888/;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            
            proxy_set_header Google-Client-ID "129544795844-404ld40323v59g792dp147dspiiseu1b.apps.googleusercontent.com";
            proxy_set_header Google-Client-Secret "8KpliuUz_J4cH3SsW43Uye39";
            
            proxy_set_header Facebook-App-ID "999273380132142";
            proxy_set_header Facebook-App-Secret "94cf4102778a15df86bd8f278049a07e";

            proxy_set_header User-Manager-URL "http://user-manager.marathon.mesos:31300/v1/users";

            proxy_set_header Auth-Provider $cookie_auth_provider;
            proxy_set_header Auth-Token $cookie_auth_token;

            proxy_set_header Auth-Fields "id,name,email,facebook_id,google_id";
        }
    }
}
