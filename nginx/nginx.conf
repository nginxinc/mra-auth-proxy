error_log /var/log/nginx/error.log debug;
worker_processes  auto;

events {
    worker_connections  1024;
}

daemon off;

http {
    include 	mime.types;
    include		nginx-gz.conf;
    resolver 	10.0.0.10 valid=3s ipv6=off;#use local DNS and override TTL to whatever value makes sense
    resolver_timeout 10s;
    client_max_body_size 30M;
    client_body_buffer_size 30M;
    proxy_cache_path /app/cache levels=1:2 keys_zone=oauth_cache:10m max_size=10m inactive=15s use_temp_path=off;

    #include /etc/nginx/conf.d/*.conf;
    upstream pages {
		server 			pages;
		zone pages 		64k;
		least_time 		last_byte;
		keepalive 		300;
	}

	upstream user-manager {
		server 			user-manager;
		zone backend 	64k;
		least_time 		last_byte;
		keepalive 		300;
	}


    server {
        listen 80 	default_server;
    	server_name  _;
        rewrite_log on;

        status_zone auth_proxy;

		keepalive_timeout	3600s;
		keepalive_disable	none;
		keepalive_requests  100000;

		error_page 401 403 /login;

        location /v1/users {
            proxy_pass http://user-manager;
            proxy_set_header Host user-manager;

            # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Accept-Encoding "";
            proxy_cache 			oauth_cache;
            proxy_cache_valid      200  30s;
            proxy_cache_use_stale  error timeout invalid_header updating
                                   http_500 http_502 http_503 http_504;

        }


        location /status.html {
        	root /usr/share/nginx/html/;
        }

        location /status {
            status;
        }

        location /pages/status.html {
            proxy_pass http://pages/status.html;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
        }

        location /pages/status {
            proxy_pass http://pages/status;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
        }

        location ~* \.(?:ico|css|js|gif|jpe?g|png|woff2|woff|ttf)$ {
            proxy_pass http://pages;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
         }


	    location = /  {
            proxy_pass http://pages;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
	    }

	    location /login {
            proxy_pass http://pages/login;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
	    }

	     location /about {
            proxy_pass http://pages/about;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
	    }

        location / {
            auth_request /auth-proxy;

            # the auth daemon will set name and email in response headers
            auth_request_set $auth_id $upstream_http_auth_id;
            auth_request_set $auth_name $upstream_http_auth_name;
            auth_request_set $auth_email $upstream_http_auth_email;
            auth_request_set $auth_facebook_id $upstream_http_auth_facebook_id;
            auth_request_set $auth_google_id $upstream_http_auth_google_id;
            auth_request_set $auth_result $upstream_http_auth_result;

            # pass data from auth daemon to pages
            proxy_set_header "Auth-ID" $auth_id;
            proxy_set_header "Auth-Name" $auth_name;
            proxy_set_header "Auth-Email" $auth_email;
            proxy_set_header "Auth-Facebook-ID" $auth_facebook_id;
            proxy_set_header "Auth-Google-ID" $auth_google_id;
            proxy_set_header "Auth-Result" $auth_result;

            proxy_pass http://pages;
            proxy_set_header Host pages;

			# Default is HTTP/1, keepalive is only enabled in HTTP/1.1
			proxy_http_version 1.1;
			proxy_set_header Connection "";
			proxy_set_header Accept-Encoding "";
        }

        location = /auth-proxy {
            internal;

            proxy_pass http://127.0.0.1:8888/;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";

            proxy_set_header Google-Client-ID "<your google client id>";
            proxy_set_header Google-Client-Secret "<your google client secret>";

            proxy_set_header Facebook-App-ID "<your facebook app id>";
            proxy_set_header Facebook-App-Secret "<your facebook app secret>";

            proxy_set_header User-Manager-URL "http://127.0.0.1/v1/users";

            proxy_set_header Auth-Provider $cookie_auth_provider;
            proxy_set_header Auth-Token $cookie_auth_token;

            proxy_set_header Auth-Fields "id,name,email,facebook_id,google_id";
        }
    }
}
